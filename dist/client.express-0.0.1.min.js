// client.express.js JavaScript Routing, version: 0.0.1
// (c) 2011 Mark Nijhof
//
//  Released under MIT license.
//
ClientExpress={};ClientExpress.createServer=function(){return new ClientExpress.Server};ClientExpress.supported=function(){return typeof window.history.pushState=="function"};
ClientExpress.Server=function(){var a=0,b=function(){this.version="0.0.1";this.id=[(new Date).valueOf(),a++].join("-");this.router=new ClientExpress.Router;this.eventListener=new ClientExpress.EventListener;this.log=new ClientExpress.Logger;this.session={}};b.prototype.logger=function(){this.log.enable()};b.prototype.use=function(a,b){var f=this;a[a.length-1]==="/"&&(a=a.substring(0,a.length-1));ClientExpress.utils.forEach(b.router.routes.get,function(b){c(f,b.method,a+b.path,b.action)})};b.prototype.get=
function(a,b){return c(this,"get",a,b)};b.prototype.post=function(a,b){return c(this,"post",a,b)};b.prototype.put=function(a,b){return c(this,"put",a,b)};b.prototype.del=function(a,b){return c(this,"del",a,b)};var c=function(a,b,c,g){a.log.information(" + ",b.toUpperCase().lpad("    "),c);a.router.registerRoute(b,c,g);return a};b.prototype.listen=function(){this.eventListener.registerEventHandlers(this);this.log.information("Listening")};b.prototype.processRequest=function(a){var b=this.router.match(a.method,
a.path);if(b.resolved()){var c=new ClientExpress.Response(a);b.action(a,c);this.log.information(200,c.request.method.toUpperCase().lpad("    "),c.request.path)}else this.log.warning(404,a.method.toUpperCase().lpad("    "),a.path),a.delegateToServer()};return b}();
ClientExpress.Route=function(){function a(a,b,d){if(a instanceof RegExp)return a;a=a.concat("/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,i,j,h){b.push({name:i,optional:!!h});c=c||"";return""+(h?"":c)+"(?:"+(h?c:"")+(d||"")+(j||"([^/]+?)")+")"+(h||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.+)");return RegExp("^"+a+"$",d?"":"i")}var b=function(b,e,d,f){this.resolved=function(){return!0};this.method=b;this.path=e;this.action=d;this.regexp=a(e,this.keys=
[],f.sensitive)};b.prototype.match=function(a){return this.regexp.exec(a)};return b}();ClientExpress.Router=function(){var a=function(){this.routes={get:[],post:[],put:[],del:[]}};a.prototype.match=function(a,c){for(var e=this.routes[a].length,d=0;d<e;++d){var f=this.routes[a][d];if(f.match(c))return f}return{resolved:function(){return!1}}};a.prototype.registerRoute=function(a,c,e){this.routes[a].push(new ClientExpress.Route(a,c,e,{sensitive:!1}))};return a}();
ClientExpress.EventListener=function(){var a=function(){};a.prototype.registerEventHandlers=function(a){b(a);c(a)};var b=function(a){document.onclick=function(b){b=b||window.event;var c=b.target||b.srcElement;if(c.tagName.toLowerCase()=="a")return b=new ClientExpress.Request({method:"get",fullPath:c.href,title:c.title,session:a.session,delegateToServer:function(){window.location.pathname=c.href}}),a.processRequest(b),!1}},c=function(a){document.onsubmit=function(b){b=b||window.event;var c=b.target||
b.srcElement;if(c.tagName.toLowerCase()=="form")return b=new ClientExpress.Request({method:c.method,fullPath:[c.action,ClientExpress.utils.serializeArray(c)].join("?"),title:c.title,session:a.session,delegateToServer:function(){c.submit()}}),a.processRequest(b),!1}};return a}();
ClientExpress.Request=function(){return function(a){var b=this;this.session=a.session;this.params={};this.title=a.title;(this.queryString=a.fullPath.split("?")[1])&&ClientExpress.utils.forEach(this.queryString.split("&"),function(a){var e=a.split("=")[0];a=a.split("=")[1];var d;if(d=/^(\w+)\[(\w+)\]/.exec(e)){var f=d[1];e=d[2];d=b.params[f]||{};d[e]=a;b.params[f]=d}else b.params[e]=a});this.method=(this.params._method||a.method).toLowerCase();this.path=a.fullPath.replace(/\?.+$/,"").replace(window.location.protocol+
"//"+window.location.host,"");this.delegateToServer=a.delegateToServer||function(){}}}();ClientExpress.Response=function(){var a=function(a){this.request=a};a.prototype.send=function(){};a.prototype.render=function(){};a.prototype.redirect=function(){};a.prototype.contentType=function(){};return a}();
ClientExpress.Logger=function(){var a=function(){this.log_enabled=!1},b=function(a){a=ClientExpress.utils.toArray(a);a.unshift("["+Date()+"]");return a.join(" ")};a.prototype.enable=function(){this.log_enabled=!0};a.prototype.error=function(){this.log_enabled&&window.console&&console.error(b(arguments))};a.prototype.information=function(){this.log_enabled&&window.console&&console.info(b(arguments))};a.prototype.warning=function(){this.log_enabled&&window.console&&console.warn(b(arguments))};return a}();
String.prototype.rpad=function(a){return a.substr(0,a.length-this.length)+this};String.prototype.lpad=function(a){return this+a.substr(0,a.length-this.length)};
ClientExpress.utils=function(){return{every:Array.prototype.every?function(a,b,c){return a.every(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;for(var d=0;d<e;d++)if(d in a&&!b.call(c,a[d],d,a))return!1;return!0},forEach:Array.prototype.forEach?function(a,b,c){return a.forEach(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;
for(var d=0;d<e;d++)d in a&&b.call(c,a[d],d,a)},filter:Array.prototype.filter?function(a,b,c){return a.filter(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;for(var d=[],f=0;f<e;f++)if(f in a){var g=a[f];b.call(c,g,f,a)&&d.push(g)}return d},map:Array.prototype.map?function(a,b,c){return a.map(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;
for(var d=Array(e),f=0;f<e;f++)f in a&&(d[f]=b.call(c,a[f],f,a));return d},toArray:function(a,b){return Array.prototype.slice.call(a,b||0)},serializeArray:function(a){var b="";a=a.getElementsByTagName("*");for(var c=0;c<a.length;c++){var e=a[c];if(!e.disabled&&e.name&&e.name.length>0)switch(e.tagName.toLowerCase()){case "input":switch(e.type){case "checkbox":case "radio":e.checked&&(b.length>0&&(b+="&"),b+=e.name+"="+encodeURIComponent(e.value));break;case "hidden":case "password":case "text":b.length>
0&&(b+="&"),b+=e.name+"="+encodeURIComponent(e.value)}break;case "select":case "textarea":b.length>0&&(b+="&"),b+=e.name+"="+encodeURIComponent(e.value)}}return b}}}();
