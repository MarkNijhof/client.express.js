// client.express.js JavaScript Routing, version: 0.0.1
// (c) 2011 Mark Nijhof
//
//  Released under MIT license.
//
ClientExpress={};ClientExpress.createServer=function(){return new ClientExpress.Server};ClientExpress.supported=function(){return typeof window.history.pushState=="function"};
ClientExpress.Server=function(){var a=0,b=function(){this.version="0.0.1";this.id=[(new Date).valueOf(),a++].join("-");this.router=new ClientExpress.Router;this.eventListener=new ClientExpress.EventListener;this.log=new ClientExpress.Logger;this.session={}};b.prototype.logger=function(){this.log.enable()};b.prototype.use=function(a,c){var b=this;a[a.length-1]==="/"&&(a=a.substring(0,a.length-1));ClientExpress.utils.forEach(c.router.routes.get,function(c){d(b,c.method,a+c.path,c.action)})};b.prototype.get=
function(a,c){return d(this,"get",a,c)};b.prototype.post=function(a,c){return d(this,"post",a,c)};b.prototype.put=function(a,c){return d(this,"put",a,c)};b.prototype.del=function(a,c){return d(this,"del",a,c)};var d=function(a,c,b,d){a.log.information(" + ",c.toUpperCase().lpad("    "),b);a.router.registerRoute(c,b,d);return a};b.prototype.listen=function(){this.eventListener.registerEventHandlers(this);this.log.information("Listening")};b.prototype.processRequest=function(a){var c=this.router.match(a.method,
a.path);if(c.resolved()){var b=new ClientExpress.Response(a,this.log);c.action(a,b);this.log.information(200,b.request.method.toUpperCase().lpad("    "),b.request.path)}else this.log.warning(404,a.method.toUpperCase().lpad("    "),a.path),a.delegateToServer()};return b}();
ClientExpress.Route=function(){function a(a,b,c){if(a instanceof RegExp)return a;a=a.concat("/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,i,j,g){b.push({name:i,optional:!!g});c=c||"";return""+(g?"":c)+"(?:"+(g?c:"")+(d||"")+(j||"([^/]+?)")+")"+(g||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.+)");return RegExp("^"+a+"$",c?"":"i")}var b=function(b,e,c,f){this.resolved=function(){return!0};this.method=b;this.path=e;this.action=c;this.regexp=a(e,this.keys=
[],f.sensitive)};b.prototype.match=function(a){return this.regexp.exec(a)};return b}();ClientExpress.Router=function(){var a=function(){this.routes={get:[],post:[],put:[],del:[]}};a.prototype.match=function(a,d){for(var e=this.routes[a].length,c=0;c<e;++c){var f=this.routes[a][c];if(f.match(d))return f}return{resolved:function(){return!1}}};a.prototype.registerRoute=function(a,d,e){this.routes[a].push(new ClientExpress.Route(a,d,e,{sensitive:!1}))};return a}();
ClientExpress.EventListener=function(){var a=function(){};a.prototype.registerEventHandlers=function(a){b(a);d(a)};var b=function(a){document.onclick=function(c){c=c||window.event;var b=c.target||c.srcElement;if(b.tagName.toLowerCase()=="a")return c=new ClientExpress.Request({method:"get",fullPath:b.href,title:b.title,session:a.session,delegateToServer:function(){window.location.pathname=b.href}}),a.processRequest(c),!1}},d=function(a){document.onsubmit=function(b){b=b||window.event;var d=b.target||
b.srcElement;if(d.tagName.toLowerCase()=="form")return b=new ClientExpress.Request({method:d.method,fullPath:[d.action,ClientExpress.utils.serializeArray(d)].join("?"),title:d.title,session:a.session,delegateToServer:function(){d.submit()}}),a.processRequest(b),!1}};return a}();
ClientExpress.Request=function(){return function(a){var b=this;this.session=a.session;this.params={};this.title=a.title;(this.queryString=a.fullPath.split("?")[1])&&ClientExpress.utils.forEach(this.queryString.split("&"),function(a){var e=a.split("=")[0];a=a.split("=")[1];var c;if(c=/^(\w+)\[(\w+)\]/.exec(e)){var f=c[1];e=c[2];c=b.params[f]||{};c[e]=a;b.params[f]=c}else b.params[e]=a});this.method=(this.params._method||a.method).toLowerCase();this.path=a.fullPath.replace(/\?.+$/,"").replace(window.location.protocol+
"//"+window.location.host,"");this.delegateToServer=a.delegateToServer||function(){}}}();ClientExpress.Response=function(){var a=function(a,d){this.request=a;this.log=d};a.prototype.send=function(){};a.prototype.render=function(){};a.prototype.redirect=function(){};a.prototype.contentType=function(){};return a}();
ClientExpress.Logger=function(){var a=function(){this.log_enabled=!1};a.prototype.enable=function(){this.log_enabled=!0};a.prototype.error=function(){this.log_enabled&&window.console&&console.error(ClientExpress.utils.toArray(arguments).join(" "))};a.prototype.information=function(){this.log_enabled&&window.console&&console.info(ClientExpress.utils.toArray(arguments).join(" "))};a.prototype.warning=function(){this.log_enabled&&window.console&&console.warn(ClientExpress.utils.toArray(arguments).join(" "))};
return a}();String.prototype.rpad=function(a){return a.substr(0,a.length-this.length)+this};String.prototype.lpad=function(a){return this+a.substr(0,a.length-this.length)};
ClientExpress.utils=function(){return{every:Array.prototype.every?function(a,b,d){return a.every(b,d)}:function(a,b,d){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;for(var c=0;c<e;c++)if(c in a&&!b.call(d,a[c],c,a))return!1;return!0},forEach:Array.prototype.forEach?function(a,b,d){return a.forEach(b,d)}:function(a,b,d){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;
for(var c=0;c<e;c++)c in a&&b.call(d,a[c],c,a)},filter:Array.prototype.filter?function(a,b,d){return a.filter(b,d)}:function(a,b,d){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;for(var c=[],f=0;f<e;f++)if(f in a){var h=a[f];b.call(d,h,f,a)&&c.push(h)}return c},map:Array.prototype.map?function(a,b,d){return a.map(b,d)}:function(a,b,d){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;
for(var c=Array(e),f=0;f<e;f++)f in a&&(c[f]=b.call(d,a[f],f,a));return c},toArray:function(a,b){return Array.prototype.slice.call(a,b||0)},serializeArray:function(a){var b="";a=a.getElementsByTagName("*");for(var d=0;d<a.length;d++){var e=a[d];if(!e.disabled&&e.name&&e.name.length>0)switch(e.tagName.toLowerCase()){case "input":switch(e.type){case "checkbox":case "radio":e.checked&&(b.length>0&&(b+="&"),b+=e.name+"="+encodeURIComponent(e.value));break;case "hidden":case "password":case "text":b.length>
0&&(b+="&"),b+=e.name+"="+encodeURIComponent(e.value)}break;case "select":case "textarea":b.length>0&&(b+="&"),b+=e.name+"="+encodeURIComponent(e.value)}}return b}}}();
