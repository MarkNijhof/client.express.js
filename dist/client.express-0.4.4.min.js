// client.express.js JavaScript Routing, version: 0.4.4
// (c) 2011 Mark Nijhof
//
//  Released under MIT license.
//
ClientExpress={};ClientExpress.createServer=function(){return new ClientExpress.Server};ClientExpress.supported=function(){return typeof window.history.pushState=="function"};ClientExpress.logger=function(){return function(){var d=new ClientExpress.Logger;this.eventBroker.addListener("onLog",function(a){a.arguments.shift()=="warning"?d.warning(a.arguments):d.information(a.arguments)})}};
ClientExpress.setTitle=function(d){var a=d&&d.titleArgument;return function(){this.eventBroker.addListener("onRequestProcessed",function(d){var e;e=d.response.title;a&&d.args[a]&&(e=d.args[a]);if(e)document.title=e})}};
ClientExpress.Server=function(){var d=0,a=function(){this.version="0.4.4";this.id=[(new Date).valueOf(),d++].join("-");this.settings={};this.templateEngines={};this.router=new ClientExpress.Router;this.eventListener=new ClientExpress.EventListener;this.eventBroker=new ClientExpress.EventBroker(this);this.session={};this.content_target_element=document.childNodes[1];this.setup_functions=[];this.log=function(){this.eventBroker.fire({type:"Log",arguments:ClientExpress.utils.toArray(arguments)})};
this.eventBroker.addListener("onProcessRequest",e);this.eventBroker.addListener("onRequestProcessed",b);this.eventBroker.addListener("onRender",g);this.eventBroker.addListener("onSend",h);this.eventBroker.addListener("onRedirect",f)};a.prototype.content_target_area=function(c){var b=this;return function(){var g=document.getElementById?document.getElementById(c):document.all?document.all[c]:document.layers?document.layers[c]:null;b.content_target_element=g||document.childNodes[1];b.content_target_element==
document.childNodes[1]&&this.log("warning",'Element "',c,'" could not be located!')}};a.prototype.configure=function(c,b){typeof c=="function"?this.setup_functions.push(c):this.setup_functions.push(function(){server.enabled(c)&&b.call()})};a.prototype.use=function(c,b){if(typeof c=="function")c.call(this);else{c[c.length-1]==="/"&&(c=c.substring(0,c.length-1));var g=function(c,b){if(b instanceof RegExp){var g=b.source;if(g.substr(0,1)=="^")return RegExp("^"+c+g.substr(1,g.length));if(g.substr(0,2)==
"\\/")return RegExp(c+g);return RegExp(c+"/"+g)}if(b=="/")return c;if(b.substr(0,1)!="/")return c+"/"+b;return c+b},a=this,h=b.router.routes;h=h.get.concat(h.post.concat(h.put.concat(h.del)));ClientExpress.utils.forEach(h,function(b){i(a,b.method,g(c,b.path),b.action,c)})}};a.prototype.set=function(c,b){if(b===void 0)if(this.settings.hasOwnProperty(c))return this.settings[c];else{if(this.parent)return this.parent.set(c)}else return this.settings[c]=b,this};a.prototype.enable=function(c){this.settings.hasOwnProperty(c);
this.settings[c]=!0};a.prototype.disable=function(c){this.settings.hasOwnProperty(c);this.settings[c]=!1};a.prototype.enabled=function(c){return this.settings.hasOwnProperty(c)&&this.settings[c]};a.prototype.disabled=function(c){return this.settings.hasOwnProperty(c)&&!this.settings[c]};a.prototype.register=function(c,b){if(b===void 0)if(this.templateEngines.hasOwnProperty(c))return this.templateEngines[c];else{if(this.parent)return this.parent.set(c)}else return this.templateEngines[c]=b,this};a.prototype.get=
function(c,b){return i(this,"get",c,b,"")};a.prototype.post=function(c,b){return i(this,"post",c,b,"")};a.prototype.put=function(c,b){return i(this,"put",c,b,"")};a.prototype.del=function(c,b){return i(this,"del",c,b,"")};var i=function(c,b,g,a,h){c.router.registerRoute(b,g,a,h);return c};a.prototype.listen=function(){if(ClientExpress.supported()){var c=this;ClientExpress.onDomReady(function(){ClientExpress.utils.forEach(c.setup_functions,function(b){b.call(c)});c.eventListener.registerEventHandlers(c);
var b=new ClientExpress.Request({method:"get",originalUrl:window.location.pathname,title:document.title,session:c.session,delegateToServer:function(){window.location.pathname=window.location.pathname}});history.replaceState(b,b.title,b.location());c.log("information","Listening");b=c.router.routes.get.concat(c.router.routes.post.concat(c.router.routes.put.concat(c.router.routes.del))).sortByName("path");ClientExpress.utils.forEach(b,function(b){c.log("information","Route registered:",b.method.toUpperCase().lpad("    "),
b.path)})})}else this.log("information","Not supported on this browser")};var e=function(b){var g=b.request,a=this.router.match(g.method,g.originalUrl);a.resolved()?(this.log("information",200,g.method.toUpperCase().lpad("    "),g.originalUrl),g.attachRoute(a),b=new ClientExpress.Response(g,this),a.action(g,b)):(this.log("information",404,g.method.toUpperCase().lpad("    "),g.originalUrl),b.request.delegateToServer())},b=function(b){if(!b.request.isHistoryRequest&&!b.request.isRedirect)b=b.request,
history.pushState(b,b.title,b.location())},g=function(b){var g=this.settings["view engine"]||"",a=(this.settings.views||"")+b.template;a.lastIndexOf(".")!=-1&&a.lastIndexOf(".")<=4&&(g=a.substr(a.lastIndexOf(".")-1,a.length),a=a.substr(0,a.lastIndexOf(".")-1));g=g||this.settings["view engine"]||"";g!=""&&(g="."+g,a+=g);b.target_element.innerHTML=this.templateEngines[g].compile(a,b.args);this.eventBroker.fire({type:"RequestProcessed",request:b.request,response:b.response,target_element:b.target_element,
args:b.args||{}})},h=function(b){b.target_element.innerHTML=b.content;this.eventBroker.fire({type:"RequestProcessed",request:b.request,response:b.response,target_element:b.target_element,args:{}})},f=function(b){this.log("information",302,"GET ",b.originalUrl);this.eventBroker.fire({type:"ProcessRequest",request:new ClientExpress.Request({method:"get",originalUrl:b.originalUrl,title:"",isRedirect:!0,session:b.request.session,delegateToServer:function(){window.location.originalUrlname=b.originalUrl}})});
this.eventBroker.fire({type:"RequestProcessed",request:b.request,response:b.response,target_element:b.target_element,args:{}})};return a}();
ClientExpress.Route=function(){function d(a,d,b){if(a instanceof RegExp)return a;a=a.concat("/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(b,a,f,c,i,j){d.push({name:c,optional:!!j});a=a||"";return""+(j?"":a)+"(?:"+(j?a:"")+(f||"")+(i||"([^/]+?)")+")"+(j||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.+)");return RegExp("^"+a+"$",b?"":"i")}var a=function(a,e,b,g,h){this.resolved=function(){return!0};this.method=a;this.path=e;this.action=b;this.base_path=g;
this.params=[];this.regexp=d(e,this.keys=[],h.sensitive)};a.prototype.match=function(a){return this.regexp.exec(a)};return a}();
ClientExpress.Router=function(){var d=function(){this.routes={get:[],post:[],put:[],del:[]}};d.prototype.match=function(a,d){for(var e=this.routes[a].length,b=0;b<e;++b){var g=this.routes[a][b];if(captures=g.match(d)){keys=g.keys;g.params=[];e=1;for(b=captures.length;e<b;++e){var h=keys[e-1],f="string"==typeof captures[e]?decodeURIComponent(captures[e]):captures[e];h?g.params[h.name]=f:g.params.push(f)}return g}}return{resolved:function(){return!1}}};d.prototype.registerRoute=function(a,d,e,b){this.routes[a].push(new ClientExpress.Route(a,
d,e,b,{sensitive:!1}))};return d}();
ClientExpress.EventBroker=function(){var d=function(a){this.server=a;this.eventListeners={}};d.prototype.addListener=function(a,d){typeof this.eventListeners[a]=="undefined"&&(this.eventListeners[a]=[]);this.eventListeners[a].push(d)};d.prototype.removeListener=function(a,d){if(this.eventListeners[a]instanceof Array){var e=this.eventListeners[a];e.forEach(function(b,a){b===d&&e.splice(a,1)})}};d.prototype.fire=function(a){typeof a=="string"&&(a={type:a});if(!a.target)a.target=this.server;if(!a.type)throw Error("Event object missing 'type' property.");
a.type="on"+a.type;this.eventListeners[a.type]instanceof Array&&this.eventListeners[a.type].forEach(function(d){d.call(this.server,a)})};return d}();
ClientExpress.EventListener=function(){var d=function(){};d.prototype.registerEventHandlers=function(b){a(b);i(b);e(b)};var a=function(b){document.onclick=function(a){a=a||window.event;var h=a.target||a.srcElement;if(h.tagName.toLowerCase()=="a")return a=new ClientExpress.Request({method:"get",originalUrl:h.href,title:h.title||"",session:b.session,delegateToServer:function(){~h.href.indexOf("://")?window.location=h.href:window.location.pathname=h.href}}),b.eventBroker.fire({type:"ProcessRequest",
request:a}),!1}},i=function(b){document.onsubmit=function(a){a=a||window.event;var h=a.target||a.srcElement;if(h.tagName.toLowerCase()=="form")return a=new ClientExpress.Request({method:h.method,originalUrl:h.action,body:ClientExpress.utils.serializeArray(h),title:h.title,session:b.session,delegateToServer:function(){h.submit()}}),b.eventBroker.fire({type:"ProcessRequest",request:a}),!1}},e=function(b){window.onpopstate=function(a){if(a.state)a=a.state,a.__proto__=ClientExpress.Request.prototype,
a.HistoryRequest(),b.eventBroker.fire({type:"ProcessRequest",request:a})}};return d}();
ClientExpress.Request=function(){var d=function(a){var d=this;this.isHistoryRequest=!1;this.session=a.session;this.title=a.title;this.body={};this.params={};this.query={};this.base_path="";this.isRedirect=a.isRedirect||!1;var e=a.originalUrl.split("?")[1],b=a.body;e&&ClientExpress.utils.forEach(e.split("&"),function(b){var a=b.split("=")[0];b=b.split("=")[1];var f;if(f=/^(\w+)\[(\w+)\]/.exec(a)){var c=f[1];a=f[2];f=d.query[c]||{};f[a]=b;d.query[c]=f}else d.query[a]=b});b&&ClientExpress.utils.forEach(b.split("&"),
function(b){var a=b.split("=")[0];b=b.split("=")[1];var f;if(f=/^(\w+)\[(\w+)\]/.exec(a)){var c=f[1];a=f[2];f=d.body[c]||{};f[a]=b;d.body[c]=f}else d.body[a]=b});this.method=(this.body._method||a.method).toLowerCase();this.originalUrl=a.originalUrl.replace(/\?.+$/,"").replace(window.location.protocol+"//"+window.location.host,"");this.delegateToServer=a.delegateToServer||function(){}};d.prototype.attachRoute=function(a){this.params=a.params;this.base_path=a.base_path;this.path=a.path};d.prototype.location=
function(){return this.method==="get"?this.originalUrl:""};d.prototype.param=function(a){return this.params[a]||this.body[a]||this.query[a]||void 0};d.prototype.HistoryRequest=function(){this.isHistoryRequest=!0};return d}();
ClientExpress.Response=function(){var d=function(a,d){this.request=a;this.server=d;this.output=this.redirect_path="";this.title=a.title};d.prototype.send=function(a){this.server.eventBroker.fire({type:"Send",request:this.request,response:this,target_element:this.server.content_target_element,content:a})};d.prototype.render=function(a,d){this.server.eventBroker.fire({type:"Render",request:this.request,response:this,target_element:this.server.content_target_element,template:a,args:d})};d.prototype.redirect=
function(a){this.server.eventBroker.fire({type:"Redirect",request:this.request,response:this,originalUrl:(a.substr(0,1)=="/"?this.request.base_path:"")+a})};return d}();ClientExpress.Logger=function(){var d=function(){};d.prototype.error=function(){window.console&&console.error(arguments[0].join(" "))};d.prototype.information=function(){window.console&&console.log(arguments[0].join(" "))};d.prototype.warning=function(){window.console&&console.warn(arguments[0].join(" "))};return d}();
String.prototype.rpad=function(d){return d.substr(0,d.length-this.length)+this};String.prototype.lpad=function(d){return this+d.substr(0,d.length-this.length)};
ClientExpress.utils=function(){var d=Array.prototype.every?function(b,a,d){return b.every(a,d)}:function(b,a,d){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;for(var c=0;c<f;c++)if(c in b&&!a.call(d,b[c],c,b))return!1;return!0},a=Array.prototype.forEach?function(b,a,d){return b.forEach(a,d)}:function(b,a,d){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;
for(var c=0;c<f;c++)c in b&&a.call(d,b[c],c,b)},i=Array.prototype.filter?function(b,a,d){return b.filter(a,d)}:function(b,a,d){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;for(var c=[],e=0;e<f;e++)if(e in b){var i=b[e];a.call(d,i,e,b)&&c.push(i)}return c},e=Array.prototype.map?function(b,a,d){return b.map(a,d)}:function(b,a,d){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;
for(var c=Array(f),e=0;e<f;e++)e in b&&(c[e]=a.call(d,b[e],e,b));return c};if(!Array.prototype.sortByName)Array.prototype.sortByName=function(b){if(this===void 0||this===null)throw new TypeError;if(typeof b!=="string")throw new TypeError;return this.sort(function(a,d){var f=(a[b]instanceof RegExp?a[b].source:a[b]).toLowerCase(),c=(d[b]instanceof RegExp?d[b].source:d[b]).toLowerCase();return f<c?-1:f>c?1:0})};return{every:d,forEach:a,filter:i,map:e,toArray:function(b,a){return Array.prototype.slice.call(b,
a||0)},serializeArray:function(b){var a="";b=b.getElementsByTagName("*");for(var d=0;d<b.length;d++){var f=b[d];if(!f.disabled&&f.name&&f.name.length>0)switch(f.tagName.toLowerCase()){case "input":switch(f.type){case "checkbox":case "radio":f.checked&&(a.length>0&&(a+="&"),a+=f.name+"="+encodeURIComponent(f.value));break;case "hidden":case "password":case "text":a.length>0&&(a+="&"),a+=f.name+"="+encodeURIComponent(f.value)}break;case "select":case "textarea":a.length>0&&(a+="&"),a+=f.name+"="+encodeURIComponent(f.value)}}return a},
objectIterator:function(a,d){for(var e in a)callBackValue={isFunction:a[e]instanceof Function,name:e,value:a[e]},d(callBackValue)}}}();
