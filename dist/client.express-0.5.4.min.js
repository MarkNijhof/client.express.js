// client.express.js JavaScript Routing, version: 0.5.4
// (c) 2011 Mark Nijhof
//
//  Released under MIT license.
//
ClientExpress={};ClientExpress.createServer=function(){return new ClientExpress.Server};ClientExpress.supported=function(){return typeof window.history.pushState=="function"};ClientExpress.logger=function(){return function(){var c=new ClientExpress.Logger;this.eventBroker.addListener("onLog",function(a){a.arguments.shift()=="warning"?c.warning(a.arguments):c.information(a.arguments)})}};
ClientExpress.setTitle=function(c){var a=c&&c.titleArgument;return function(){this.eventBroker.addListener("onRequestProcessed",function(c){var e;e=c.response.title;a&&c.args[a]&&(e=c.args[a]);if(e)document.title=e})}};ClientExpress.googleAnalytics=function(){return function(){this.eventBroker.addListener("onRequestProcessed",function(c){c.isRedirect||_gaq&&_gaq.push(["_trackPageview",c.request.originalUrl])})}};
ClientExpress.Server=function(){var c=0,a=function(){this.version="0.5.4";this.id=[(new Date).valueOf(),c++].join("-");this.settings={};this.templateEngines={};this.router=new ClientExpress.Router;this.eventListener=new ClientExpress.EventListener;this.eventBroker=new ClientExpress.EventBroker(this);this.session={};this.content_target_element=document.childNodes[1];this.setup_functions=[];this.log=function(){this.eventBroker.fire({type:"Log",arguments:ClientExpress.utils.toArray(arguments)})};
this.eventBroker.addListener("onProcessRequest",e);this.eventBroker.addListener("onRequestProcessed",b);this.eventBroker.addListener("onRender",g);this.eventBroker.addListener("onSend",h);this.eventBroker.addListener("onRedirect",f)};a.prototype.content_target_area=function(d){var b=this;return function(){var g=document.getElementById?document.getElementById(d):document.all?document.all[d]:document.layers?document.layers[d]:null;b.content_target_element=g||document.childNodes[1];b.content_target_element==
document.childNodes[1]&&this.log("warning",'Element "',d,'" could not be located!')}};a.prototype.configure=function(d,b){typeof d=="function"?this.setup_functions.push(d):this.setup_functions.push(function(){server.enabled(d)&&b.call()})};a.prototype.use=function(d,b){if(typeof d=="function")d.call(this);else{d[d.length-1]==="/"&&(d=d.substring(0,d.length-1));var g=function(d,b){if(b instanceof RegExp){var g=b.source;if(g.substr(0,1)=="^")return RegExp("^"+d+g.substr(1,g.length));if(g.substr(0,2)==
"\\/")return RegExp(d+g);return RegExp(d+"/"+g)}if(b=="/")return d;if(b.substr(0,1)!="/")return d+"/"+b;return d+b},a=this,h=b.router.routes;h=h.get.concat(h.post.concat(h.put.concat(h.del)));ClientExpress.utils.forEach(h,function(b){i(a,b.method,g(d,b.path),b.action,d)})}};a.prototype.set=function(d,b){if(b===void 0)if(this.settings.hasOwnProperty(d))return this.settings[d];else{if(this.parent)return this.parent.set(d)}else return this.settings[d]=b,this};a.prototype.enable=function(d){this.settings.hasOwnProperty(d);
this.settings[d]=!0};a.prototype.disable=function(d){this.settings.hasOwnProperty(d);this.settings[d]=!1};a.prototype.enabled=function(d){return this.settings.hasOwnProperty(d)&&this.settings[d]};a.prototype.disabled=function(d){return this.settings.hasOwnProperty(d)&&!this.settings[d]};a.prototype.register=function(d,b){if(b===void 0)if(this.templateEngines.hasOwnProperty(d))return this.templateEngines[d];else{if(this.parent)return this.parent.set(d)}else return this.templateEngines[d]=b,this};a.prototype.get=
function(d,b){return i(this,"get",d,b,"")};a.prototype.post=function(d,b){return i(this,"post",d,b,"")};a.prototype.put=function(d,b){return i(this,"put",d,b,"")};a.prototype.del=function(d,b){return i(this,"del",d,b,"")};var i=function(d,b,g,a,h){d.router.registerRoute(b,g,a,h);return d};a.prototype.listen=function(){if(ClientExpress.supported()){var d=this;ClientExpress.onDomReady(function(){ClientExpress.utils.forEach(d.setup_functions,function(b){b.call(d)});d.eventListener.registerEventHandlers(d);
var b=new ClientExpress.Request({method:"get",originalUrl:window.location.pathname,title:document.title,session:d.session,delegateToServer:function(){window.location.pathname=window.location.pathname}});history.replaceState(b,b.title,b.location());d.log("information","Listening");b=d.router.routes.get.concat(d.router.routes.post.concat(d.router.routes.put.concat(d.router.routes.del))).sortByName("path");ClientExpress.utils.forEach(b,function(b){d.log("information","Route registered:",b.method.toUpperCase().lpad("    "),
b.path)})})}else this.log("information","Not supported on this browser")};var e=function(b){var g=b.request,a=this.router.match(g.method,g.originalUrl);a.resolved()?(this.log("information",200,g.method.toUpperCase().lpad("    "),g.originalUrl),g.attachRoute(a),b=new ClientExpress.Response(g,this),a.action(g,b)):(this.log("information",404,g.method.toUpperCase().lpad("    "),g.originalUrl),b.request.delegateToServer())},b=function(b){if(!b.request.isHistoryRequest&&!b.request.isRedirect)b=b.request,
history.pushState(b,b.title,b.location())},g=function(b){var g=this.settings["view engine"]||"",a=(this.settings.views||"")+b.template;a.lastIndexOf(".")!=-1&&a.lastIndexOf(".")<=4&&(g=a.substr(a.lastIndexOf(".")-1,a.length),a=a.substr(0,a.lastIndexOf(".")-1));g=g||this.settings["view engine"]||"";g!=""&&(g="."+g,a+=g);b.target_element.innerHTML=this.templateEngines[g].compile(a,b.args);this.eventBroker.fire({type:"RequestProcessed",request:b.request,response:b.response,target_element:b.target_element,
args:b.args||{}})},h=function(b){b.target_element.innerHTML=b.content;this.eventBroker.fire({type:"RequestProcessed",request:b.request,response:b.response,target_element:b.target_element,args:{}})},f=function(b){this.log("information",302,"GET ",b.originalUrl);this.eventBroker.fire({type:"ProcessRequest",request:new ClientExpress.Request({method:"get",originalUrl:b.originalUrl,title:"",isRedirect:!0,session:b.request.session,delegateToServer:function(){window.location.originalUrlname=b.originalUrl}})});
this.eventBroker.fire({type:"RequestProcessed",request:b.request,response:b.response,target_element:b.target_element,args:{}})};return a}();
ClientExpress.Route=function(){function c(a,c,b){if(a instanceof RegExp)return a;a=a.concat("/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(b,a,f,d,i,j){c.push({name:d,optional:!!j});a=a||"";return""+(j?"":a)+"(?:"+(j?a:"")+(f||"")+(i||"([^/]+?)")+")"+(j||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.+)");return RegExp("^"+a+"$",b?"":"i")}var a=function(a,e,b,g,h){this.resolved=function(){return!0};this.method=a;this.path=e;this.action=b;this.base_path=g;
this.params=[];this.regexp=c(e,this.keys=[],h.sensitive)};a.prototype.match=function(a){return this.regexp.exec(a)};return a}();
ClientExpress.Router=function(){var c=function(){this.routes={get:[],post:[],put:[],del:[]}};c.prototype.match=function(a,c){for(var e=this.routes[a].length,b=0;b<e;++b){var g=this.routes[a][b];if(captures=g.match(c)){keys=g.keys;g.params=[];e=1;for(b=captures.length;e<b;++e){var h=keys[e-1],f="string"==typeof captures[e]?decodeURIComponent(captures[e]):captures[e];h?g.params[h.name]=f:g.params.push(f)}return g}}return{resolved:function(){return!1}}};c.prototype.registerRoute=function(a,c,e,b){this.routes[a].push(new ClientExpress.Route(a,
c,e,b,{sensitive:!1}))};return c}();
ClientExpress.EventBroker=function(){var c=function(a){this.server=a;this.eventListeners={}};c.prototype.addListener=function(a,c){typeof this.eventListeners[a]=="undefined"&&(this.eventListeners[a]=[]);this.eventListeners[a].push(c)};c.prototype.removeListener=function(a,c){if(this.eventListeners[a]instanceof Array){var e=this.eventListeners[a];e.forEach(function(b,a){b===c&&e.splice(a,1)})}};c.prototype.fire=function(a){typeof a=="string"&&(a={type:a});if(!a.target)a.target=this.server;if(!a.type)throw Error("Event object missing 'type' property.");
a.type="on"+a.type;this.eventListeners[a.type]instanceof Array&&this.eventListeners[a.type].forEach(function(c){c.call(this.server,a)})};return c}();
ClientExpress.EventListener=function(){var c=function(){};c.prototype.registerEventHandlers=function(b){a(b);i(b);e(b)};var a=function(b){document.onclick=function(a){a=a||window.event;var h=a.target||a.srcElement;if(h.tagName.toLowerCase()=="a")return a=new ClientExpress.Request({method:"get",originalUrl:h.href,title:h.title||"",session:b.session,delegateToServer:function(){~h.href.indexOf("://")?window.location=h.href:window.location.pathname=h.href}}),b.eventBroker.fire({type:"ProcessRequest",
request:a}),!1}},i=function(b){document.onsubmit=function(a){a=a||window.event;var h=a.target||a.srcElement;if(h.tagName.toLowerCase()=="form")return a=new ClientExpress.Request({method:h.method,originalUrl:h.action,body:ClientExpress.utils.serializeArray(h),title:h.title,session:b.session,delegateToServer:function(){h.submit()}}),b.eventBroker.fire({type:"ProcessRequest",request:a}),!1}},e=function(b){window.onpopstate=function(a){if(a.state)a=a.state,a.__proto__=ClientExpress.Request.prototype,
a.HistoryRequest(),b.eventBroker.fire({type:"ProcessRequest",request:a})}};return c}();
ClientExpress.Request=function(){var c=function(a){var c=this;this.isHistoryRequest=!1;this.session=a.session;this.title=a.title;this.body={};this.params={};this.query={};this.base_path="";this.isRedirect=a.isRedirect||!1;var e=a.originalUrl.split("?")[1],b=a.body;e&&ClientExpress.utils.forEach(e.split("&"),function(b){var a=b.split("=")[0];b=b.split("=")[1];var f;if(f=/^(\w+)\[(\w+)\]/.exec(a)){var d=f[1];a=f[2];f=c.query[d]||{};f[a]=b;c.query[d]=f}else c.query[a]=b});b&&ClientExpress.utils.forEach(b.split("&"),
function(b){var a=b.split("=")[0];b=b.split("=")[1];var f;if(f=/^(\w+)\[(\w+)\]/.exec(a)){var d=f[1];a=f[2];f=c.body[d]||{};f[a]=b;c.body[d]=f}else c.body[a]=b});this.method=(this.body._method||a.method).toLowerCase();this.originalUrl=a.originalUrl.replace(/\?.+$/,"").replace(window.location.protocol+"//"+window.location.host,"");this.delegateToServer=a.delegateToServer||function(){}};c.prototype.attachRoute=function(a){this.params=a.params;this.base_path=a.base_path;this.path=a.path};c.prototype.location=
function(){return this.method==="get"?this.originalUrl:""};c.prototype.param=function(a){return this.params[a]||this.body[a]||this.query[a]||void 0};c.prototype.HistoryRequest=function(){this.isHistoryRequest=!0};return c}();
ClientExpress.Response=function(){var c=function(a,c){this.request=a;this.server=c;this.output=this.redirect_path="";this.title=a.title};c.prototype.send=function(a){this.server.eventBroker.fire({type:"Send",request:this.request,response:this,target_element:this.server.content_target_element,content:a})};c.prototype.render=function(a,c){this.server.eventBroker.fire({type:"Render",request:this.request,response:this,target_element:this.server.content_target_element,template:a,args:c})};c.prototype.redirect=
function(a){this.server.eventBroker.fire({type:"Redirect",request:this.request,response:this,originalUrl:(a.substr(0,1)=="/"?this.request.base_path:"")+a})};return c}();ClientExpress.Logger=function(){var c=function(){};c.prototype.error=function(){window.console&&console.error(arguments[0].join(" "))};c.prototype.information=function(){window.console&&console.log(arguments[0].join(" "))};c.prototype.warning=function(){window.console&&console.warn(arguments[0].join(" "))};return c}();
String.prototype.rpad=function(c){return c.substr(0,c.length-this.length)+this};String.prototype.lpad=function(c){return this+c.substr(0,c.length-this.length)};
ClientExpress.utils=function(){var c=Array.prototype.every?function(b,a,c){return b.every(a,c)}:function(b,a,c){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;for(var d=0;d<f;d++)if(d in b&&!a.call(c,b[d],d,b))return!1;return!0},a=Array.prototype.forEach?function(b,a,c){return b.forEach(a,c)}:function(b,a,c){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;
for(var d=0;d<f;d++)d in b&&a.call(c,b[d],d,b)},i=Array.prototype.filter?function(b,a,c){return b.filter(a,c)}:function(b,a,c){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;for(var d=[],e=0;e<f;e++)if(e in b){var i=b[e];a.call(c,i,e,b)&&d.push(i)}return d},e=Array.prototype.map?function(b,a,c){return b.map(a,c)}:function(b,a,c){if(b===void 0||b===null)throw new TypeError;b=Object(b);var f=b.length>>>0;if(typeof a!=="function")throw new TypeError;
for(var d=Array(f),e=0;e<f;e++)e in b&&(d[e]=a.call(c,b[e],e,b));return d};if(!Array.prototype.sortByName)Array.prototype.sortByName=function(b){if(this===void 0||this===null)throw new TypeError;if(typeof b!=="string")throw new TypeError;return this.sort(function(a,c){var f=(a[b]instanceof RegExp?a[b].source:a[b]).toLowerCase(),d=(c[b]instanceof RegExp?c[b].source:c[b]).toLowerCase();return f<d?-1:f>d?1:0})};return{every:c,forEach:a,filter:i,map:e,toArray:function(b,a){return Array.prototype.slice.call(b,
a||0)},serializeArray:function(b){var a="";b=b.getElementsByTagName("*");for(var c=0;c<b.length;c++){var f=b[c];if(!f.disabled&&f.name&&f.name.length>0)switch(f.tagName.toLowerCase()){case "input":switch(f.type){case "checkbox":case "radio":f.checked&&(a.length>0&&(a+="&"),a+=f.name+"="+encodeURIComponent(f.value));break;case "hidden":case "password":case "text":a.length>0&&(a+="&"),a+=f.name+"="+encodeURIComponent(f.value)}break;case "select":case "textarea":a.length>0&&(a+="&"),a+=f.name+"="+encodeURIComponent(f.value)}}return a},
objectIterator:function(a,c){for(var e in a)callBackValue={isFunction:a[e]instanceof Function,name:e,value:a[e]},c(callBackValue)}}}();
