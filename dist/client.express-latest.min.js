// client.express.js JavaScript Routing, version: 0.3.3
// (c) 2011 Mark Nijhof
//
//  Released under MIT license.
//
ClientExpress={};ClientExpress.createServer=function(){return new ClientExpress.Server};ClientExpress.supported=function(){return typeof window.history.pushState=="function"};ClientExpress.logger=function(){return function(){var b=new ClientExpress.Logger;this.eventBroker.addListener("onLog",function(a){a.arguments.shift()=="warning"?b.warning(a.arguments):b.information(a.arguments)})}};
ClientExpress.Server=function(){var b=0,a=function(){this.version="0.3.3";this.id=[(new Date).valueOf(),b++].join("-");this.settings={};this.templateEngines={};this.router=new ClientExpress.Router;this.eventListener=new ClientExpress.EventListener;this.eventBroker=new ClientExpress.EventBroker(this);this.session={};this.content_target_element=document.childNodes[1];this.setup_functions=[];this.log=function(){this.eventBroker.fire({type:"Log",arguments:ClientExpress.utils.toArray(arguments)})};
this.eventBroker.addListener("onProcessRequest",c);this.eventBroker.addListener("onRender",e);this.eventBroker.addListener("onSend",d);this.eventBroker.addListener("onRedirect",g)};a.prototype.content_target_area=function(a){var b=this;return function(){var f=document.getElementById?document.getElementById(a):document.all?document.all[a]:document.layers?document.layers[a]:null;b.content_target_element=f||document.childNodes[1];b.content_target_element==document.childNodes[1]&&this.log("warning",'Element "',
a,'" could not be located!')}};a.prototype.configure=function(a,b){typeof a=="function"?this.setup_functions.push(a):this.setup_functions.push(function(){server.enabled(a)&&b.call()})};a.prototype.use=function(a,b){if(typeof a=="function")a.call(this);else{a[a.length-1]==="/"&&(a=a.substring(0,a.length-1));var d=function(a,b){if(b=="/")return a;if(b.substr(0,1)!="/")return a+"/"+b;return a+b},c=this,e=b.router.routes;ClientExpress.utils.forEach(e.get,function(b){f(c,b.method,d(a,b.path),b.action,
a)});ClientExpress.utils.forEach(e.post,function(b){f(c,b.method,d(a,b.path),b.action,a)});ClientExpress.utils.forEach(e.put,function(b){f(c,b.method,d(a,b.path),b.action,a)});ClientExpress.utils.forEach(e.del,function(b){f(c,b.method,d(a,b.path),b.action,a)})}};a.prototype.set=function(a,b){if(b===void 0)if(this.settings.hasOwnProperty(a))return this.settings[a];else{if(this.parent)return this.parent.set(a)}else return this.settings[a]=b,this};a.prototype.enable=function(a){this.settings.hasOwnProperty(a);
this.settings[a]=!0};a.prototype.disable=function(a){this.settings.hasOwnProperty(a);this.settings[a]=!1};a.prototype.enabled=function(a){return this.settings.hasOwnProperty(a)&&this.settings[a]};a.prototype.disabled=function(a){return this.settings.hasOwnProperty(a)&&!this.settings[a]};a.prototype.register=function(a,b){if(b===void 0)if(this.templateEngines.hasOwnProperty(a))return this.templateEngines[a];else{if(this.parent)return this.parent.set(a)}else return this.templateEngines[a]=b,this};a.prototype.get=
function(a,b){return f(this,"get",a,b,"")};a.prototype.post=function(a,b){return f(this,"post",a,b,"")};a.prototype.put=function(a,b){return f(this,"put",a,b,"")};a.prototype.del=function(a,b){return f(this,"del",a,b,"")};var f=function(a,b,f,d,c){a.router.registerRoute(b,f,d,c);return a};a.prototype.listen=function(){if(ClientExpress.supported()){var a=this;ClientExpress.onDomReady(function(){ClientExpress.utils.forEach(a.setup_functions,function(b){b.call(a)});a.eventListener.registerEventHandlers(a);
var b=new ClientExpress.Request({method:"get",fullPath:window.location.pathname,title:document.title,session:a.session,delegateToServer:function(){window.location.pathname=window.location.pathname}});history.replaceState(b,b.title,b.location());a.log("information","Listening");b=a.router.routes;ClientExpress.utils.forEach(b.get,function(b){a.log("information","Route loaded:",b.method.toUpperCase().lpad("    "),b.path)});ClientExpress.utils.forEach(b.post,function(b){a.log("information","Route loaded:",
b.method.toUpperCase().lpad("    "),b.path)});ClientExpress.utils.forEach(b.put,function(b){a.log("information","Route loaded:",b.method.toUpperCase().lpad("    "),b.path)});ClientExpress.utils.forEach(b.del,function(b){a.log("information","Route loaded:",b.method.toUpperCase().lpad("    "),b.path)})})}else this.log("information","Not supported on this browser")};var c=function(a){var b=this.router.match(a.request.method,a.request.path);if(b.resolved()){this.log("information",200,a.request.method.toUpperCase().lpad("    "),
a.request.path);a.request.attachRoute(b);var f=new ClientExpress.Response(a.request,this);if(!a.request.isHistoryRequest&&!a.request.isRedirect){var d=a.request;history.pushState(d,d.title,d.location())}b.action(a.request,f)}else this.log("information",404,a.request.method.toUpperCase().lpad("    "),a.request.path),a.request.delegateToServer()},e=function(a){var b=this.settings["view engine"]||"",d=(this.settings.views||"")+a.template;d.lastIndexOf(".")!=-1&&d.lastIndexOf(".")<=4&&(b=d.substr(d.lastIndexOf(".")-
1,d.length),d=d.substr(0,d.lastIndexOf(".")-1));b=b||this.settings["view engine"]||"";b!=""&&(b="."+b,d+=b);this.eventBroker.fire({type:"Send",request:a.request,target_element:a.target_element,content:this.templateEngines[b].compile(d,a.args)})},d=function(a){a.target_element.innerHTML=a.content},g=function(a){this.log("information",302,"GET ",a.path);this.eventBroker.fire({type:"ProcessRequest",request:new ClientExpress.Request({method:"get",fullPath:a.path,title:"",isRedirect:!0,session:this.session,
delegateToServer:function(){window.location.pathname=a.path}})})};return a}();
ClientExpress.Route=function(){function b(a,b,e){if(a instanceof RegExp)return a;a=a.concat("/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,f,e,j,k,h){b.push({name:j,optional:!!h});f=f||"";return""+(h?"":f)+"(?:"+(h?f:"")+(e||"")+(k||"([^/]+?)")+")"+(h||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.+)");return RegExp("^"+a+"$",e?"":"i")}var a=function(a,c,e,d,g){this.resolved=function(){return!0};this.method=a;this.path=c;this.action=e;this.base_path=d;
this.params=[];this.regexp=b(c,this.keys=[],g.sensitive)};a.prototype.match=function(a){return this.regexp.exec(a)};return a}();
ClientExpress.Router=function(){var b=function(){this.routes={get:[],post:[],put:[],del:[]}};b.prototype.match=function(a,b){for(var c=this.routes[a].length,e=0;e<c;++e){var d=this.routes[a][e];if(captures=d.match(b)){keys=d.keys;d.params=[];c=1;for(e=captures.length;c<e;++c){var g=keys[c-1],i="string"==typeof captures[c]?decodeURIComponent(captures[c]):captures[c];g?d.params[g.name]=i:d.params.push(i)}return d}}return{resolved:function(){return!1}}};b.prototype.registerRoute=function(a,b,c,e){this.routes[a].push(new ClientExpress.Route(a,
b,c,e,{sensitive:!1}))};return b}();
ClientExpress.EventBroker=function(){var b=function(a){this.server=a;this._listeners={}};b.prototype.addListener=function(a,b){typeof this._listeners[a]=="undefined"&&(this._listeners[a]=[]);this._listeners[a].push(b)};b.prototype.removeListener=function(a,b){if(this._listeners[a]instanceof Array){var c=this._listeners[a];c.forEach(function(a,d){a===b&&c.splice(d,1)})}};b.prototype.fire=function(a){typeof a=="string"&&(a={type:a});if(!a.target)a.target=this.server;if(!a.type)throw Error("Event object missing 'type' property.");
a.type="on"+a.type;this._listeners[a.type]instanceof Array&&this._listeners[a.type].forEach(function(b){b.call(this.server,a)})};return b}();
ClientExpress.EventListener=function(){var b=function(){};b.prototype.registerEventHandlers=function(b){a(b);f(b);c(b)};var a=function(a){document.onclick=function(b){b=b||window.event;var c=b.target||b.srcElement;if(c.tagName.toLowerCase()=="a")return b=new ClientExpress.Request({method:"get",fullPath:c.href,title:c.title||"",session:a.session,delegateToServer:function(){c.href.indexOf("://")!=-1?window.location=c.href:window.location.pathname=c.href}}),a.eventBroker.fire({type:"ProcessRequest",
request:b}),!1}},f=function(a){document.onsubmit=function(b){b=b||window.event;var c=b.target||b.srcElement;if(c.tagName.toLowerCase()=="form")return b=new ClientExpress.Request({method:c.method,fullPath:[c.action,ClientExpress.utils.serializeArray(c)].join("?"),title:c.title,session:a.session,delegateToServer:function(){c.submit()}}),a.eventBroker.fire({type:"ProcessRequest",request:b}),!1}},c=function(a){window.onpopstate=function(b){if(b.state)b=b.state,b.__proto__=ClientExpress.Request.prototype,
b.HistoryRequest(),a.eventBroker.fire({type:"ProcessRequest",request:b})}};return b}();
ClientExpress.Request=function(){var b=function(a){var b=this;this.isHistoryRequest=!1;this.session=a.session;this.body={};this.title=a.title;this.params=[];this.base_path="";this.isRedirect=a.isRedirect||!1;(this.queryString=a.fullPath.split("?")[1])&&ClientExpress.utils.forEach(this.queryString.split("&"),function(a){var e=a.split("=")[0];a=a.split("=")[1];var d;if(d=/^(\w+)\[(\w+)\]/.exec(e)){var g=d[1];e=d[2];d=b.body[g]||{};d[e]=a;b.body[g]=d}else b.body[e]=a});this.method=(this.body._method||
a.method).toLowerCase();this.path=a.fullPath.replace(/\?.+$/,"").replace(window.location.protocol+"//"+window.location.host,"");this.delegateToServer=a.delegateToServer||function(){}};b.prototype.attachRoute=function(a){this.params=a.params;this.base_path=a.base_path};b.prototype.location=function(){return this.method==="get"?this.path:""};b.prototype.HistoryRequest=function(){this.isHistoryRequest=!0};return b}();
ClientExpress.Response=function(){var b=function(a,b){this.request=a;this.server=b;this.output=this.redirect_path=""};b.prototype.send=function(a){this.server.eventBroker.fire({type:"Send",request:this.request,target_element:this.server.content_target_element,content:a})};b.prototype.render=function(a,b){this.server.eventBroker.fire({type:"Render",request:this.request,target_element:this.server.content_target_element,template:a,args:b})};b.prototype.redirect=function(a){this.server.eventBroker.fire({type:"Redirect",
request:this.request,path:(a.substr(0,1)=="/"?this.request.base_path:"")+a})};return b}();ClientExpress.Logger=function(){var b=function(){};b.prototype.error=function(){window.console&&console.error(ClientExpress.utils.toArray(arguments).join(" "))};b.prototype.information=function(){window.console&&console.log(ClientExpress.utils.toArray(arguments).join(" "))};b.prototype.warning=function(){window.console&&console.warn(ClientExpress.utils.toArray(arguments).join(" "))};return b}();
String.prototype.rpad=function(b){return b.substr(0,b.length-this.length)+this};String.prototype.lpad=function(b){return this+b.substr(0,b.length-this.length)};
ClientExpress.utils=function(){return{every:Array.prototype.every?function(b,a,f){return b.every(a,f)}:function(b,a,f){if(b===void 0||b===null)throw new TypeError;b=Object(b);var c=b.length>>>0;if(typeof a!=="function")throw new TypeError;for(var e=0;e<c;e++)if(e in b&&!a.call(f,b[e],e,b))return!1;return!0},forEach:Array.prototype.forEach?function(b,a,f){return b.forEach(a,f)}:function(b,a,f){if(b===void 0||b===null)throw new TypeError;b=Object(b);var c=b.length>>>0;if(typeof a!=="function")throw new TypeError;
for(var e=0;e<c;e++)e in b&&a.call(f,b[e],e,b)},filter:Array.prototype.filter?function(b,a,f){return b.filter(a,f)}:function(b,a,f){if(b===void 0||b===null)throw new TypeError;b=Object(b);var c=b.length>>>0;if(typeof a!=="function")throw new TypeError;for(var e=[],d=0;d<c;d++)if(d in b){var g=b[d];a.call(f,g,d,b)&&e.push(g)}return e},map:Array.prototype.map?function(b,a,f){return b.map(a,f)}:function(b,a,f){if(b===void 0||b===null)throw new TypeError;b=Object(b);var c=b.length>>>0;if(typeof a!=="function")throw new TypeError;
for(var e=Array(c),d=0;d<c;d++)d in b&&(e[d]=a.call(f,b[d],d,b));return e},toArray:function(b,a){return Array.prototype.slice.call(b,a||0)},serializeArray:function(b){var a="";b=b.getElementsByTagName("*");for(var f=0;f<b.length;f++){var c=b[f];if(!c.disabled&&c.name&&c.name.length>0)switch(c.tagName.toLowerCase()){case "input":switch(c.type){case "checkbox":case "radio":c.checked&&(a.length>0&&(a+="&"),a+=c.name+"="+encodeURIComponent(c.value));break;case "hidden":case "password":case "text":a.length>
0&&(a+="&"),a+=c.name+"="+encodeURIComponent(c.value)}break;case "select":case "textarea":a.length>0&&(a+="&"),a+=c.name+"="+encodeURIComponent(c.value)}}return a}}}();
